name: Generate RSS Feed

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'amo_latest_*.xml'
      - 'public/**'
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Generate RSS feeds (addons, extensions, themes)
        run: |
          set -euo pipefail
          # 1) Generate the default "addons" feed (all types)
          python generate_amo_rss_Version2.py
          if [ -f public/amo_latest_addons.xml ]; then cp public/amo_latest_addons.xml /tmp/amo_latest_addons.xml; fi

          # 2) Generate extensions-only feed
          python generate_amo_rss_Version2.py --type "extension"
          if [ -f public/amo_latest_extensions.xml ]; then cp public/amo_latest_extensions.xml /tmp/amo_latest_extensions.xml; fi

          # 3) Generate themes-only feed
          python generate_amo_rss_Version2.py --type "theme"
          if [ -f public/amo_latest_themes.xml ]; then cp public/amo_latest_themes.xml /tmp/amo_latest_themes.xml; fi

          # Restore the canonical full addons feed into public/
          if [ -f /tmp/amo_latest_addons.xml ]; then cp /tmp/amo_latest_addons.xml public/amo_latest_addons.xml; fi
          # Ensure extensions/themes are present in public/ (copy back from tmp if needed)
          if [ -f /tmp/amo_latest_extensions.xml ]; then cp /tmp/amo_latest_extensions.xml public/amo_latest_extensions.xml; fi
          if [ -f /tmp/amo_latest_themes.xml ]; then cp /tmp/amo_latest_themes.xml public/amo_latest_themes.xml; fi
      - name: Freshness check (fail if feed stale)
        env:
          AMO_MAX_STALE_HOURS: '6'
        run: |
          set -euo pipefail
          # Run the generator again under a freshness threshold so it exits non-zero when the newest item is older than AMO_MAX_STALE_HOURS
          python generate_amo_rss_Version2.py --type "extension"
          python generate_amo_rss_Version2.py
      - name: Prepare publish directory
        run: |
          mkdir -p public
          # Publish feeds in two places:
          # - repo root: served as https://<user>.github.io/<repo>/amo_latest_*.xml
          # - public/: served as https://<user>.github.io/<repo>/public/amo_latest_*.xml
          if [ -f public/amo_latest_addons.xml ]; then cp public/amo_latest_addons.xml .; fi
          if [ -f public/amo_latest_extensions.xml ]; then cp public/amo_latest_extensions.xml .; fi
          if [ -f public/amo_latest_themes.xml ]; then cp public/amo_latest_themes.xml .; fi
      - name: Prepare Pages artifact (root + public)
        run: |
          mkdir -p _pages_artifact
          # Copy root-level XMLs
          if [ -f amo_latest_addons.xml ]; then cp amo_latest_addons.xml _pages_artifact/; fi
          if [ -f amo_latest_extensions.xml ]; then cp amo_latest_extensions.xml _pages_artifact/; fi
          if [ -f amo_latest_themes.xml ]; then cp amo_latest_themes.xml _pages_artifact/; fi
          # Copy public/ directory contents
          if [ -d public ]; then cp -r public _pages_artifact/; fi
          # If a favicon exists in public/, copy it to site root in the artifact
          if [ -f public/favicon.ico ]; then cp public/favicon.ico _pages_artifact/favicon.ico; fi
          # Also copy repo-root .ico or .png favicon if present
          if [ -f favicon.ico ]; then cp favicon.ico _pages_artifact/favicon.ico; fi
          if [ -f favicon.png ]; then cp favicon.png _pages_artifact/favicon.png; fi
          # Also provide a fallback at /favicon.ico by copying the PNG (helps some clients)
          if [ -f favicon.png ]; then cp favicon.png _pages_artifact/favicon.ico; fi
          # Create a minimal index.html at the site root so the homepage doesn't 404
          cat > _pages_artifact/index.html <<'HTML'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width,initial-scale=1">
            <title>AMO Add-ons RSS</title>
            <link rel="icon" type="image/png" href="/favicon.png">
            <link rel="shortcut icon" href="/favicon.png">
          </head>
          <body>
            <h1>AMO Add-ons RSS</h1>
            <p>Feeds generated from Mozilla AMO.</p>
            <ul>
              <li><a href="amo_latest_addons.xml">Latest Addons (root)</a></li>
              <li><a href="amo_latest_extensions.xml">Latest Extensions (root)</a></li>
              <li><a href="amo_latest_themes.xml">Latest Themes (root)</a></li>
              <li><a href="public/amo_latest_extensions.xml">Latest Extensions (public)</a></li>
              <li><a href="public/">Public directory</a></li>
            </ul>
          </body>
          </html>
          HTML
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_pages_artifact

      - name: Commit generated feeds to main
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A amo_latest_*.xml public/amo_latest_*.xml || true
          if git diff --staged --quiet; then
            echo "No feed changes to commit"
          else
            # Do NOT use [skip ci] here; it prevents the Pages deployment workflow
            # from running on the generated commits.
            git commit -m "Publish generated feeds: ${{ github.sha }}"
            # Try push; if rejected because remote advanced, attempt to rebase and push again.
            if git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:main; then
              echo "Pushed successfully"
            else
              echo "Push rejected, attempting to rebase onto origin/main"
              git fetch origin main
              if git rebase origin/main; then
                git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:main
              else
                echo "Rebase failed â€” aborting rebase and trying force-with-lease push"
                git rebase --abort || true
                git push --force-with-lease https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:main
              fi
            fi
          fi

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
