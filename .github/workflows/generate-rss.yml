name: Generate RSS Feed

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'amo_latest_*.xml'
      - 'public/**'
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Generate RSS feeds (addons, extensions, themes)
        run: |
          set -euo pipefail
          # 1) Generate the default "addons" feed (all types)
          python generate_amo_rss_Version2.py
          if [ -f public/amo_latest_addons.xml ]; then cp public/amo_latest_addons.xml /tmp/amo_latest_addons.xml; fi

          # 2) Generate extensions-only feed
          python generate_amo_rss_Version2.py --type "extension"
          if [ -f public/amo_latest_extensions.xml ]; then cp public/amo_latest_extensions.xml /tmp/amo_latest_extensions.xml; fi

          # 3) Generate themes-only feed
          python generate_amo_rss_Version2.py --type "theme"
          if [ -f public/amo_latest_themes.xml ]; then cp public/amo_latest_themes.xml /tmp/amo_latest_themes.xml; fi

          # Restore the canonical full addons feed into public/
          if [ -f /tmp/amo_latest_addons.xml ]; then cp /tmp/amo_latest_addons.xml public/amo_latest_addons.xml; fi
          # Ensure extensions/themes are present in public/ (copy back from tmp if needed)
          if [ -f /tmp/amo_latest_extensions.xml ]; then cp /tmp/amo_latest_extensions.xml public/amo_latest_extensions.xml; fi
          if [ -f /tmp/amo_latest_themes.xml ]; then cp /tmp/amo_latest_themes.xml public/amo_latest_themes.xml; fi
      - name: Freshness check (fail if feed stale)
        env:
          AMO_MAX_STALE_HOURS: '6'
        run: |
          set -euo pipefail
          # Run the generator again under a freshness threshold so it exits non-zero when the newest item is older than AMO_MAX_STALE_HOURS
          python generate_amo_rss_Version2.py --type "extension"
          python generate_amo_rss_Version2.py
      - name: Prepare publish directory
        run: |
          mkdir -p public
          # Publish feeds in two places:
          # - repo root: served as https://<user>.github.io/<repo>/amo_latest_*.xml
          # - public/: served as https://<user>.github.io/<repo>/public/amo_latest_*.xml
          if [ -f public/amo_latest_addons.xml ]; then cp public/amo_latest_addons.xml .; fi
          if [ -f public/amo_latest_extensions.xml ]; then cp public/amo_latest_extensions.xml .; fi
          if [ -f public/amo_latest_themes.xml ]; then cp public/amo_latest_themes.xml .; fi
      - name: Configure Pages
        uses: actions/configure-pages@v3

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v1

      - name: Commit generated feeds to main
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A amo_latest_*.xml public/amo_latest_*.xml || true
          if git diff --staged --quiet; then
            echo "No feed changes to commit"
          else
            # Do NOT use [skip ci] here; it prevents the Pages deployment workflow
            # from running on the generated commits.
            git commit -m "Publish generated feeds: ${{ github.sha }}"
            # Try push; if rejected because remote advanced, attempt to rebase and push again.
            if git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:main; then
              echo "Pushed successfully"
            else
              echo "Push rejected, attempting to rebase onto origin/main"
              git fetch origin main
              if git rebase origin/main; then
                git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:main
              else
                echo "Rebase failed â€” aborting rebase and trying force-with-lease push"
                git rebase --abort || true
                git push --force-with-lease https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:main
              fi
            fi
          fi
